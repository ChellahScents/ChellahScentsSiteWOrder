<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Order Services • Chellah Scents</title>

  <link rel="stylesheet" href="css/styles.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- PayPal Smart Buttons SDK -->
  <script 
  src="https://www.paypal.com/sdk/js?client-id=BAATnBGQXYI0HMbpx7ZaSd6JZ3g0lyXYzc8g9Ew-016JDolN8YbMVuqlRiL682Ka3ArrULuJ_xz-xziw-8&components=hosted-buttons&disable-funding=venmo&currency=USD">
</script>
</head>
<body>

  <div class="zellige-bg"></div>

  <header>
    <nav class="navbar">
      <a href="index.html" class="nav-logo"><img src="img/logo.png" alt="Chellah Scents Logo"></a>
      <button class="nav-toggle" aria-label="Toggle menu">☰</button>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="consulting.html">Consulting</a></li>
        <li><a href="printing.html">3D Printing</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="order.html" class="active">Order</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="order-section">
      <div class="order-header">
        <h2>Order Transcription · Translation · Subtitling</h2>
        <p class="order-intro">Complete the form below, upload your files, choose your delivery speed, then pay securely.</p>
      </div>

      <form id="order-form">
        <input type="hidden" name="orderNumber" id="orderNumber" value="">

        <label>Your Email (Deliver To)
          <input type="email" name="customerEmail" required placeholder="you@example.com">
        </label>

        <label>Original Language
          <input list="allLangs" name="sourceLang" required>
          <datalist id="allLangs">
            <option value="English"><option value="French"><option value="Arabic">
            <option value="Spanish"><option value="Mandarin"><option value="Hindi">
          </datalist>
        </label>

        <label>Target Language(s)
          <select name="targetLangs" multiple size="3" required>
            <option>English</option>
            <option>French</option>
            <option>Arabic</option>
          </select>
          <small>Ctrl/Cmd + click to select multiple</small>
        </label>

        <fieldset>
          <legend>Select Service(s)</legend>
          <label><input type="checkbox" name="service" value="translation"> Translation</label>
          <label><input type="checkbox" name="service" value="transcription"> Transcription</label>
          <label><input type="checkbox" name="service" value="subtitling"> Subtitle (SRT)</label>
        </fieldset>

        <div id="translation-fields" class="hidden">
          <label>Approx. Word Count
            <input type="number" name="wordCount" min="0" value="0">
          </label>
        </div>

        <div id="audio-fields" class="hidden">
          <label>Audio/Video Length (minutes)
            <input type="number" name="lengthMin" min="0" value="0">
          </label>
        </div>

        <label class="rush-label">
          <input type="checkbox" name="rush" value="true">
          Delivery in under 12 hours (+25% surcharge)
        </label>

        <label>Upload Your Files
          <input type="file" name="attachments" id="fileInput" multiple required>
        </label>

        <label>Additional Instructions
          <textarea name="notes" rows="3" placeholder="Any special requests?"></textarea>
        </label>

        <p><strong>Total: $<span id="total-price">0.00</span></strong></p>

        <div id="paypal-container-KAMZYXTN97LT8"></div>
        <script>
            paypal.HostedButtons({
                 hostedButtonId: "KAMZYXTN97LT8",
             }).render("#paypal-container-KAMZYXTN97LT8");
        </script>
      </form>

      <p class="eta-notice">
        Standard turnaround: 24–48 hours.<br>
        Rush turnaround: under 12 hours (+25%).<br>
        Questions? Email <a href="mailto:contact@chellah-scents.com">contact@chellah-scents.com</a>.
      </p>
    </section>
  </main>

  <footer>
    <p>© 2024 Chellah Scents · Rooted Past, Soaring Future</p>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIIyuFigBoRR7Ev9wULduht3nx5kxp6i4",
      authDomain: "chellah-orders.firebaseapp.com",
      projectId: "chellah-orders",
      storageBucket: "chellah-orders.appspot.com",
      messagingSenderId: "577794209323",
      appId: "1:577794209323:web:6da2e20a2ddc1718945c6e",
      measurementId: "G-Q624T3QYFW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    function calculateTotal() {
      const form = document.getElementById('order-form');
      const services = [...form.querySelectorAll('input[name="service"]:checked')].map(el => el.value);
      const wordCount = parseInt(form.wordCount?.value || "0");
      const lengthMin = parseInt(form.lengthMin?.value || "0");
      const isRush = form.rush?.checked;

      let total = 0;

      if (services.includes("translation")) total += wordCount * 0.10;
      if (services.includes("transcription")) total += lengthMin * 1.00;
      if (services.includes("subtitling")) total += lengthMin * 1.25;

      if (isRush) total *= 1.25;

      return total;
    }

    function updateTotalDisplay() {
      const total = calculateTotal();
      document.getElementById("total-price").textContent = total.toFixed(2);
    }

    document.getElementById("order-form").addEventListener("change", updateTotalDisplay);
    document.getElementById("order-form").addEventListener("input", updateTotalDisplay);

    document.addEventListener("DOMContentLoaded", () => {
      paypal.Buttons({
        style: {
          layout: 'vertical',
          color: 'gold',
          shape: 'rect',
          label: 'paypal'
        },
        createOrder: function(data, actions) {
          const price = calculateTotal().toFixed(2);
          return actions.order.create({
            purchase_units: [{
              amount: { value: price }
            }]
          });
        },
        onApprove: async function(data, actions) {
          try {
            await actions.order.capture();

            const form = document.getElementById('order-form');
            const formData = new FormData(form);
            const orderID = `ORD-${Date.now()}`;

            const order = {
              orderID,
              customerEmail: formData.get("customerEmail"),
              sourceLang: formData.get("sourceLang"),
              targetLangs: formData.getAll("targetLangs"),
              services: formData.getAll("service"),
              wordCount: formData.get("wordCount"),
              lengthMin: formData.get("lengthMin"),
              rush: formData.get("rush") === "true",
              notes: formData.get("notes"),
              paid: true,
              totalPaid: calculateTotal().toFixed(2),
              timestamp: new Date().toISOString()
            };

            await db.collection("orders").doc(orderID).set(order);

            const files = document.getElementById("fileInput").files;
            const fileLinks = [];

            for (const file of files) {
              const fileRef = storage.ref(`orders/${orderID}/${file.name}`);
              await fileRef.put(file);
              const url = await fileRef.getDownloadURL();
              fileLinks.push(url);
            }

            await db.collection("mail").add({
              to: ["mbounejmate@gmail.com"],
              message: {
                subject: `New Order Received: ${orderID}`,
                html: `
                  <p><strong>Order ID:</strong> ${orderID}</p>
                  <p><strong>Email:</strong> ${order.customerEmail}</p>
                  <p><strong>Services:</strong> ${order.services.join(", ")}</p>
                  <p><strong>Languages:</strong> ${order.sourceLang} → ${order.targetLangs.join(", ")}</p>
                  <p><strong>Word Count:</strong> ${order.wordCount}</p>
                  <p><strong>Length (min):</strong> ${order.lengthMin}</p>
                  <p><strong>Rush:</strong> ${order.rush ? "Yes" : "No"}</p>
                  <p><strong>Notes:</strong> ${order.notes}</p>
                  <p><strong>Files:</strong></p>
                  <ul>${fileLinks.map(link => `<li><a href="${link}">${link}</a></li>`).join("")}</ul>
                `
              }
            });

            alert("Order placed and payment received!");
            form.reset();
            updateTotalDisplay();
          } catch (err) {
            console.error("Order submission error:", err);
            alert("Something went wrong. Please try again.");
          }
        },
        onError: function(err) {
          console.error("PayPal error:", err);
          alert("Payment could not be completed. Please try again.");
        }
      }).render('#paypal-button-container');
    });
  </script>
</body>
</html>
